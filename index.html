<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <title>Listen Together</title>
  <link rel="stylesheet" href="https://cdn.plyr.io/3.7.2/plyr.css"/>
  <style>body{margin:0;font-family:system-ui;background:#111;color:#eee}
         #topbar{padding:.6rem 1rem;background:#222}
         input,button{padding:.4rem .8rem;margin-right:.5rem}
         #drop{border:2px dashed #555;padding:2rem;text-align:center;margin:1rem}
  </style>
</head>
<body>
<div id="topbar">
  <input id="url" placeholder="YouTube or direct .mp3/.mp4 URL">
  <button id="go">Load</button>
  <button id="create">Create room</button>
  <span id="status">Not connected</span>
</div>
<div id="drop">or drop a local file here</div>
<video id="v" controls style="width:100%"></video>

<script type="module">
/* ==========  CONFIG – paste your own ========== */
const firebaseConfig = {
  apiKey: "AIzaSyCce9in03U6uwBlN-eotf3WLYbK1Kn7qLw", authDomain: "shared-meditation.firebaseapp.com", databaseURL: "https://shared-meditation-default-rtdb.europe-west1.firebasedatabase.app/", projectId: "shared-meditation"
};
/* ============================================== */

import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
import { getDatabase, ref, push, onValue, set } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-database.js";
import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";
import Plyr from "https://cdn.skypack.dev/plyr@3.7.2";
import SimplePeer from "https://cdn.skypack.dev/simple-peer@9.11.1";

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const auth = getAuth(app);
await signInAnonymously(auth);

let roomId = new URLSearchParams(location.search).get('r');
let owner = false;
let ignore = false;               // ignore our own Firebase echoes
let peer;
let uid = auth.currentUser.uid;
const v = document.getElementById('v');
const player = new Plyr(v, {youtube: { noCookie: false }});
  
/* ----------  room handling ---------- */
if (!roomId) {
  document.getElementById('create').onclick = () => {
    roomId = Math.random().toString(36).slice(2,8);
    history.replaceState({}, '', '?r=' + roomId);
    startRoom();
  };
} else {
  startRoom();
}

/* 1.  if a source was already chosen, load it now */
const roomSource = ref(db, 'rooms/' + roomId + '/source');
onValue(roomSource, snap => {
  if (!snap.exists()) return;          // nessuno ha ancora scelto
  const {src, provider} = snap.val();
  if (src && !player.currentSrc) {     // evita ricaricare due volte
      player.source = {
        type: 'video',
        sources: [{provider, src}],
        origin: window.location.origin  // ← risolve anche i problemi Safari
      };
  }
});

/* 2.  quando il primo utente sceglie, salvalo in Firebase */
function loadYT(url){
  player.source = {
    type: 'video',
    sources: [{provider:'youtube', src:url}],
    origin: window.location.origin
  };
  set(ref(db, 'rooms/' + roomId + '/source'),
     {src:url, provider:'youtube'});
}

function startRoom() {
  owner = true;
  const roomRef = ref(db, 'rooms/' + roomId);
  set(roomRef, {owner: uid, created: Date.now()});  
  listenCommands();
  document.getElementById('status').textContent = 'Room: ' + roomId;
}

function listenCommands() {
  onValue(ref(db, 'rooms/' + roomId + '/command'), snap => {
    if (!snap.exists()) return;
    const {op, at, uid:from} = snap.val();
    console.log('Valore cambiato - op:', uid.toString(), ' - uid:', uid);
    if (from === uid) return;          // own echo
    ignore = true;
    if (op === 'play') { player.currentTime = at; player.play(); }
    if (op === 'pause') { player.currentTime = at; player.pause(); }
    ignore = false;
  });
}

function broadcast(op, currTime) {
  set(ref(db, 'rooms/' + roomId + '/command'), {op, at: currTime, uid})
    .then(() => console.log('✅ play scritto da', uid.toString()))
    .catch(e => console.error('❌ write failed', e));
}

/* ----------  media source ---------- */
document.getElementById('go').onclick = () => loadURL(document.getElementById('url').value);

function loadURL(src) {
  if (src.includes('youtube.com') || src.includes('youtu.be')) {
    player.source = {type: 'video', sources: [{provider: 'youtube', src}]};
    loadYT(src);
  } else {
    v.src = src;
  }
}

/* drag-drop local file */
const drop = document.getElementById('drop');
drop.ondragover = e => e.preventDefault();
drop.ondrop = async e => {
  e.preventDefault();
  const file = e.dataTransfer.files[0];
  if (!file) return;
  drop.style.display = 'none';
  if (!roomId) { alert('Create a room first'); return; }
  if (owner) {
    v.src = URL.createObjectURL(file);
    await setupPeer(file);
  } else {
    await setupPeer();          // receiver side
  }
};

/* ----------  WebRTC for local file ---------- */
async function setupPeer(file) {
  peer = new SimplePeer({ initiator: !!file, trickle: false });
  if (file) {
    peer.on('signal', data => push(ref(db, 'rooms/' + roomId + '/signal'), data));
    const buf = await file.arrayBuffer();
    peer.on('connect', () => peer.send(buf));
  } else {
    onValue(ref(db, 'rooms/' + roomId + '/signal'), snap => {
      if (snap.exists()) peer.signal(snap.val());
    });
    peer.on('data', buf => {
      const blob = new Blob([buf], {type: file ? file.type : 'video/mp4'});
      v.src = URL.createObjectURL(blob);
    });
  }
}

/* ----------  sync play/pause ---------- */
player.on('play',       () => !ignore && broadcast('play', player.currentTime));
player.on('pause',      () => !ignore && broadcast('pause', player.currentTime));
let last = 0;
player.on('timeupdate', () => {
  if (Math.abs(player.currentTime - last) > 1) broadcast('play', player.currentTime);
  last = player.currentTime;
});

/*
document.getElementById('v').onplay = () => !ignore && broadcast('play', v.currentTime);
document.getElementById('v').onpause = () => !ignore && broadcast('pause', v.currentTime);
let last = 0;
document.getElementById('v').onseeked = () => {
  if (Math.abs(v.currentTime - last) > 1) broadcast('play', v.currentTime); // seek ≈ play at new time
  last = v.currentTime;
};
*/
</script>
</body>
</html>
